version: 2
jobs:
  build:
    docker:
      - image: circleci/python:3.6-jessie
    steps:
      - checkout

      - run:
          name: Install Dependencies
          command: |
            sudo apt-get install openjdk-8-jdk maven zip unzip

      - run:
          name: Install AWS-CLI
          command: |
            sudo pip install awscli

      - run:
          name: Build Artifact
          command: |
            # cd webapp
            # ./gradlew war
            # cd build/libs
            # ls -al
            # cd ../../..
            cd webapp
            mvn clean install -Pprod

      - run:
          name: Zip Artifact
          command: |
            # echo "Hello the current build number is ${CIRCLE_BUILD_NUM}"
            # pwd
            # ls -al
            # mkdir -p codedeploy_artifact
            # cp infrastructure/aws/codedeploy/*.sh .
            # zip -r csye6225-web-app-${CIRCLE_BUILD_NUM}.zip webapp/build/libs/ROOT.war *.sh *.yml
            # ls -al
            # mv csye6225-web-app-${CIRCLE_BUILD_NUM}.zip codedeploy_artifact/
            # ls -al
            # pwd
            # cd codedeploy_artifact
            # ls -al
            # pwd
            # cd ..
            # pwd
            # ls -al
            mkdir -p codedeploy_artifact
            cp infrastructure/aws/codedeploy/*.sh .
            zip -r csye6225-web-app-${CIRCLE_BUILD_NUM}.zip webapp/target/ROOT.war *.sh *.yml
            mv csye6225-web-app-${CIRCLE_BUILD_NUM}.zip codedeploy_artifact/

      - run:
          name: Upload Artifact to S3
          command: |
            echo "uploading artifact"
            aws s3 cp csye6225-web-app-${CIRCLE_BUILD_NUM}.zip s3://csye6225-su19-ahujapra.me.csye6225.com/abc.zip

      - run:
          name: Make CodeDeploy API call
          command: |
            echo "Hello CodeDeploy" 